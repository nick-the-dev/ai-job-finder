generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id             String   @id @default(uuid())
  contentHash    String   @unique @map("content_hash")

  // Basic info
  title          String
  company        String
  description    String

  // Location
  location       String?
  isRemote       Boolean  @default(false) @map("is_remote")

  // Salary
  salaryMin      Int?     @map("salary_min")
  salaryMax      Int?     @map("salary_max")
  salaryCurrency String?  @map("salary_currency")

  // Source
  source         String   // serpapi, jobspy
  sourceId       String?  @map("source_id")
  applicationUrl String?  @map("application_url")

  // Timestamps
  postedDate     DateTime? @map("posted_date")
  firstSeenAt    DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt     DateTime  @default(now()) @map("last_seen_at")

  // Relations
  matches        JobMatch[]

  @@map("jobs")
}

model JobMatch {
  id          String   @id @default(uuid())

  // Job relation
  jobId       String   @map("job_id")
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Match analysis
  score       Int      // 1-100
  reasoning   String   // Why this score

  // Skills analysis
  matchedSkills  String[] @map("matched_skills")
  missingSkills  String[] @map("missing_skills")

  // Recommendations
  pros        String[]
  cons        String[]

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("job_matches")
}

model SearchConfig {
  id              String   @id @default(uuid())
  name            String   @unique

  // Search criteria
  jobTitles       String[] @map("job_titles")
  locations       String[]
  isRemote        Boolean  @default(true) @map("is_remote")

  // Exclusions
  excludedTitles  String[] @map("excluded_titles")
  excludedCompanies String[] @map("excluded_companies")

  // Resume for matching
  resumeText      String?  @map("resume_text")

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("search_configs")
}

// Cache for API query results to avoid duplicate calls
model QueryCache {
  id           String   @id @default(uuid())

  // Query parameters (hashed for lookup)
  queryHash    String   @unique @map("query_hash")

  // Query details
  query        String   // The search query
  location     String?
  isRemote     Boolean  @default(false) @map("is_remote")
  source       String   // serpapi, jobspy

  // Results metadata
  jobCount     Int      @map("job_count")

  // Timestamps
  fetchedAt    DateTime @default(now()) @map("fetched_at")
  expiresAt    DateTime @map("expires_at")

  @@map("query_cache")
}

// Cache for query expansions to avoid repeated LLM calls
model QueryExpansion {
  id              String   @id @default(uuid())

  // Cache key (hash of job titles + resume snippet)
  cacheKey        String   @unique @map("cache_key")

  // Original input
  originalQueries String[] @map("original_queries")

  // LLM-generated expansions
  expandedQueries String[] @map("expanded_queries")
  resumeSuggested String[] @map("resume_suggested")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("query_expansions")
}
